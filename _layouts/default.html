<!DOCTYPE html>
<html lang="en-us">

  {% include head.html %}

  <body class="theme-base-{{ site.theme.hyde_theme | default: '0d' }} {{ site.theme.layout | default: 'layout-reverse' }}">

    {% include sidebar.html %}

    <div class="content container mathjax-content">
      {{ content }}
    </div>

    {% if site.features.chat_enabled != false %}
    <!-- Floating Chat: launcher -->
    <button id="chat-launcher" aria-label="Open {{ site.content.chat.title | default: 'Chat' }}"
            aria-expanded="false" class="chat-launcher" type="button">ðŸ’¬</button>

    <!-- Backdrop (mobile/fullscreen) -->
    <div id="chat-backdrop" class="chat-backdrop" hidden></div>

    <!-- Floating Chat: widget -->
    <aside id="chat-widget" class="chat-widget" aria-hidden="true"
           role="dialog" aria-label="{{ site.content.chat.title | default: 'Paper Search Chat' }}">
      <header class="chat-widget__header">
        <strong>{{ site.content.chat.title | default: 'Paper Search Chat' }}</strong>
        <button id="chat-close" class="chat-close" aria-label="Close chat" type="button">âœ•</button>
      </header>
      <div class="chat-widget__body">
        <div id="alp-chat-mount" aria-live="polite"></div>
      </div>
    </aside>

    <script defer>
      (function(){
        const widget   = document.getElementById('chat-widget');
        const launcher = document.getElementById('chat-launcher');
        const closeBtn = document.getElementById('chat-close');
        const backdrop = document.getElementById('chat-backdrop');
        const mount    = document.getElementById('alp-chat-mount');
        const OPEN_KEY = 'site_chat_open';
        let loaded = false;

        function openChat(){
          widget.classList.add('open');
          widget.setAttribute('aria-hidden','false');
          launcher.setAttribute('aria-expanded','true');
          backdrop.hidden = false;
          localStorage.setItem(OPEN_KEY, '1');

          // Lazy-load chat bundle once
          if(!loaded){
            loaded = true;
            const s = document.createElement('script');
            s.src = '{{ site.baseurl }}/assets/js/alp-chat.js';
            s.defer = true;
            s.onload = () => window.ALPChat?.mount(mount);
            document.body.appendChild(s);
          }else{
            setTimeout(()=> widget.querySelector('#query')?.focus(), 50);
          }
        }

        function closeChat(){
          widget.classList.remove('open');
          widget.setAttribute('aria-hidden','true');
          launcher.setAttribute('aria-expanded','false');
          backdrop.hidden = true;
          localStorage.removeItem(OPEN_KEY);
          launcher.focus();
        }

        function toggleChat(){
          widget.classList.contains('open') ? closeChat() : openChat();
        }

        launcher.addEventListener('click', toggleChat);
        closeBtn.addEventListener('click', closeChat);
        backdrop.addEventListener('click', closeChat);
        document.addEventListener('keydown', e => {
          if(e.key === 'Escape' && widget.classList.contains('open')) closeChat();
        });

        // Restore previous open state
        if(localStorage.getItem(OPEN_KEY) === '1'){ openChat(); }
      })();
    </script>
    {% endif %}

    <!-- 
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        let isBot = true;
        document.addEventListener('mousemove', () => isBot = false);
        document.addEventListener('keydown', () => isBot = false);
        setTimeout(function () {
          if (isBot) window.location.href = '/challenge-page.html';
        }, 5000);
      });
    </script>
    -->
  </body>
</html>
